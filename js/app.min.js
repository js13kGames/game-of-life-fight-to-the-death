function getEl(e){return document.querySelector(e)}function init(e){generation=0,oranges=0,greens=0,dead=0,maxGen=+form.gennum.value,S=Math.floor(windowW/colN),rowN=Math.floor(windowH/S),W=S*colN,H=S*rowN,dW=(windowW-W)/2,dH=(windowH-H)/2,colHN=(colN-1)/2,halfW=S*colHN,maxLС=getCellsNumber(),informer=new Informer,game.width=W,game.height=H,grid.width=W,grid.height=H,game.style.left=dW+"px",game.style.top=dH+"px",grid.style.left=dW+"px",grid.style.top=dH+"px",pane.style.top=dH+"px",pane.style.right=dW+"px",pane.style.width=halfW+"px",pane.style.height=H+"px",form.livecells.value=maxLС,playerArr=getEmptyArray(colHN,rowN),enemyArr=getTribeArray(colHN,rowN,2),drawStage(playerArr,!0),gridOn&&drawGrid(S,colN,rowN,!0),e&&remClass(pane,"hidden")}function Informer(){var e=this,n=W/4,a=H/8,r=a/1.2,t=(W-n)/2,o=(H-a)/2,l=t+n/2,i=l-n/10,g=l+n/10,s=o+a/2;e.draw=function(){gс.font=r+"px fantasy",gс.textBaseline="middle",gс.fillStyle="#5A1F00",gс.lineWidth=5,gс.strokeStyle="#FDE792",gс.fillRect(t,o,n,a),gс.strokeRect(t,o,n,a),gс.fillStyle="#D1570D",gс.textAlign="end",gс.fillText(oranges,i,s),gс.textAlign="center",gс.fillStyle="#FDE792",gс.fillText(":",l,s),gс.textAlign="start",gс.fillStyle="#477725",gс.fillText(greens,g,s)}}function getEmptyArray(e,n){for(var a,r=[],t=0;e>t;t++)for(r[t]=new Array(n),a=0;n>a;)r[t][a++]=0;return r}function getTribeArray(e,n,a){for(var r,t=getInitArray(e,n,a),o=[];t.length;)r=t.splice(0,n),o.push(r);return o}function getInitArray(e,n,a){var r,t,o=e*n-maxLС,l=new Array(maxLС),i=new Array(o);for(t=0;maxLС>t;)l[t++]=a;for(t=0;o>t;)i[t++]=0;return r=l.concat(i),shuffle(r)}function joinArrays(e,n){for(var a=e[0].length,r=new Array(a),t=0;a>t;)r[t++]=0;return e.concat([r],n)}function shuffle(e){for(var n,a=e.length;a;)n=Math.floor(Math.random()*a--),e[a]=[e[n],e[n]=e[a]][0];return e}function getCellsNumber(){return Math.floor(colHN*rowN*P)}function gameInit(){addClass(pane,"hidden"),bf1=getEmptyArray(colN,rowN),bf2=joinArrays(playerArr,enemyArr),gridOn&&drawGrid(S,colN,rowN),drawStage(bf2)}function drawStage(e,n){var a,r=e.length,t=0,o=0;for("right"===n&&(o=halfW+S);r>t;t++)for(a=0;rowN>a;a++)drawCell(o+t*S,a*S,e[t][a])}function drawGrid(e,n,a,r){var t,o=r?halfW:W,l=r?colHN+1:n+1,i=0;for(gс.strokeStyle=CLRS[3],gс.clearRect(0,0,W,H);l>i;i++)t=i*e,drawLine(t,0,t,H);for(i=0;a+1>i;i++)t=i*e,drawLine(0,t,o,t)}function drawLine(e,n,a,r){gс.beginPath(),gс.moveTo(e,n),gс.lineTo(a,r),gс.stroke()}function drawCell(e,n,a){c.fillStyle=CLRS[a],c.fillRect(e,n,S,S)}function showMustGoOn(){animation=!animation,animation&&requestAnimationFrame(nextGen)}function nextGen(){for(var e,n=0;colN>n;n++)for(e=0;rowN>e;e++)bf1[n][e]=calcState(n,e),drawCell(n*S,e*S,bf1[n][e]);bf1=[bf2,bf2=bf1][0],generation++,animation?generation>=maxGen?(animation=!animation,displayResults()):requestAnimationFrame(nextGen):generation>=maxGen&&displayResults()}function displayResults(){var e,n=bf2.length,a=0;for(dead=0,oranges=0,greens=0;n>a;a++)for(e=0;rowN>e;e++)bf2[a][e]?1===bf2[a][e]?oranges++:greens++:dead++;informer.draw()}function calcState(e,n){for(var a,r=0>e-1?colN-1:e-1,t=e+1>colN-1?0:e+1,o=0>n-1?rowN-1:n-1,l=n+1>rowN-1?0:n+1,i=[bf2[r][o],bf2[r][n],bf2[r][l],bf2[e][o],bf2[e][l],bf2[t][o],bf2[t][n],bf2[t][l]],g=0,s=0,f=0,d=0;8>d;d++)i[d]?1===i[d]?s++:f++:g++;return a=s+f,bf2[e][n]?2>a||a>3?0:bf2[e][n]:3!==a?0:f>s?2:s>f?1:Math.floor(Math.random()+.5)}function applyConfig(){colN=+form.colnum.value,P=+form.popdens.value,maxGen=+form.gennum.value,gridOn=+form.showgrid.value,init()}function onSpanMouseUp(e){var n=document.getElementById(e.target.id.replace("nav","pane")),a=0;if(hasClass(e.target,"inactive-btn")){for(;a<navbtns.length;a++)addClass(navbtns[a],"inactive-btn");for(remClass(e.target,"inactive-btn"),a=0;a<panels.length;a++)addClass(panels[a],"hidden");remClass(n,"hidden")}}function onCanvasMouseUp(){dragging=!1}function onCanvasMouseDown(e){dragging=!0,onCanvasMouseMove(e)}function onCanvasMouseMove(e){if(dragging&&!animation){var n=getPointerPos(e.target,e),a=Math.floor(n.x/S),r=Math.floor(n.y/S);n.x<halfW?(сellCache.i!==a||сellCache.j!==r)&&(playerArr[a][r]=playerArr[a][r]?0:1,сellCache.i=a,сellCache.j=r,drawStage(playerArr,"left")):n.x>halfW+S&&(a-=colHN+1,(сellCache1.i!==a||сellCache1.j!==r)&&(enemyArr[a][r]=enemyArr[a][r]?0:2,сellCache1.i=a,сellCache1.j=r,drawStage(enemyArr,"right")))}}function getCellCoord(e){Math.round(e.x/S),Math.round(e.y/S)}function hasClass(e,n){return(" "+e.className+" ").indexOf(" "+n+" ")>-1}function addClass(e,n){hasClass(e,n)||(e.className+=" "+n)}function remClass(e,n){e.className=e.className.replace(" "+n,"")}function getPointerPos(e,n){var a=e.getBoundingClientRect();return{x:n.pageX-a.left,y:n.pageY-a.top}}function pointInRect(e,n){return inRange(e.x,n.x,n.x+n.w)&&inRange(e.y,n.y,n.y+n.h)}function inRange(e,n,a){return e>=Math.min(n,a)&&e<=Math.max(n,a)}var colN=51,P=.5,S,rowN,playerArr,playerLC,enemyArr,enemyLC,battleArr1,battleArr2,maxLС,W,H,dW,dH,halfW,colHN,maxGen,CLRS=["#5A1F00","#D1570D","#477725","rgba(0,0,0,1)"],animation=!1,gridOn=!0,сellCache={i:1e3,j:1e3},сellCache1={i:1e3,j:1e3},dragging,oranges,greens,dead,generation,game=getEl("#game"),grid=getEl("#grid"),pane=getEl("#pane"),apply=getEl("#apply"),rulesBtn=getEl("#nav-rules"),optionBtn=getEl("#nav-option"),navbtns=document.getElementsByClassName("btn"),panels=document.getElementsByClassName("panels"),form=document.forms[0],c=game.getContext("2d"),gс=grid.getContext("2d"),b=document.body,windowW=window.innerWidth,windowH=window.innerHeight,informer,battleArr1,battleArr2;b.onkeyup=function(e){switch(e.keyCode){case 32:showMustGoOn();break;case 27:animation||init(!0);break;case 39:animation||nextGen();break;case 37:animation||nextGen();break;case 38:animation||nextGen();break;case 40:animation||nextGen()}},b.onmouseup=function(e){if("SPAN"===e.target.nodeName)onSpanMouseUp(e);else if("CANVAS"===e.target.nodeName)onCanvasMouseUp(e);else if("DIV"===e.target.nodeName)switch(e.target.id){case"apply":applyConfig();break;case"start":gameInit();break;case"generate":playerArr=getTribeArray(colHN,rowN,1),drawStage(playerArr,!0);break;case"reset":playerArr=getEmptyArray(colHN,rowN),drawStage(playerArr,!0);break;default:return!1}},grid.onmousedown=onCanvasMouseDown,grid.onmousemove=onCanvasMouseMove,init();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLm1pbi5qcyIsInNvdXJjZXMiOlsiYS5qcyIsImIuanMiLCJjLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWlDQSxRQUFBLE9BQUEsR0FDQSxNQUFBLFVBQUEsY0FBQSxHQXFCQSxRQUFBLE1BQUEsR0FDQSxXQUFBLEVBQ0EsUUFBQSxFQUNBLE9BQUEsRUFDQSxLQUFBLEVBQ0EsUUFBQSxLQUFBLE9BQUEsTUFDQSxFQUFBLEtBQUEsTUFBQSxRQUFBLE1BQ0EsS0FBQSxLQUFBLE1BQUEsUUFBQSxHQUNBLEVBQUEsRUFBQSxLQUNBLEVBQUEsRUFBQSxLQUNBLElBQUEsUUFBQSxHQUFBLEVBQ0EsSUFBQSxRQUFBLEdBQUEsRUFDQSxPQUFBLEtBQUEsR0FBQSxFQUNBLE1BQUEsRUFBQSxNQUNBLE1BQUEsaUJBQ0EsU0FBQSxHQUFBLFVBRUEsS0FBQSxNQUFBLEVBQ0EsS0FBQSxPQUFBLEVBQ0EsS0FBQSxNQUFBLEVBQ0EsS0FBQSxPQUFBLEVBQ0EsS0FBQSxNQUFBLEtBQUEsR0FBQSxLQUNBLEtBQUEsTUFBQSxJQUFBLEdBQUEsS0FDQSxLQUFBLE1BQUEsS0FBQSxHQUFBLEtBQ0EsS0FBQSxNQUFBLElBQUEsR0FBQSxLQUVBLEtBQUEsTUFBQSxJQUFBLEdBQUEsS0FDQSxLQUFBLE1BQUEsTUFBQSxHQUFBLEtBQ0EsS0FBQSxNQUFBLE1BQUEsTUFBQSxLQUNBLEtBQUEsTUFBQSxPQUFBLEVBQUEsS0FDQSxLQUFBLFVBQUEsTUFBQSxNQUVBLFVBQUEsY0FBQSxNQUFBLE1BQ0EsU0FBQSxjQUFBLE1BQUEsS0FBQSxHQUVBLFVBQUEsV0FBQSxHQUNBLFFBQUEsU0FBQSxFQUFBLEtBQUEsTUFBQSxHQUNBLEdBQUEsU0FBQSxLQUFBLFVBR0EsUUFBQSxZQUNBLEdBQUEsR0FBQSxLQUNBLEVBQUEsRUFBQSxFQUNBLEVBQUEsRUFBQSxFQUNBLEVBQUEsRUFBQSxJQUNBLEdBQUEsRUFBQSxHQUFBLEVBQ0EsR0FBQSxFQUFBLEdBQUEsRUFDQSxFQUFBLEVBQUEsRUFBQSxFQUNBLEVBQUEsRUFBQSxFQUFBLEdBQ0EsRUFBQSxFQUFBLEVBQUEsR0FDQSxFQUFBLEVBQUEsRUFBQSxDQUdBLEdBQUEsS0FBQSxXQUNBLEdBQUEsS0FBQSxFQUFBLGFBQ0EsR0FBQSxhQUFBLFNBQ0EsR0FBQSxVQUFBLFVBQ0EsR0FBQSxVQUFBLEVBQ0EsR0FBQSxZQUFBLFVBQ0EsR0FBQSxTQUFBLEVBQUEsRUFBQSxFQUFBLEdBQ0EsR0FBQSxXQUFBLEVBQUEsRUFBQSxFQUFBLEdBQ0EsR0FBQSxVQUFBLFVBQ0EsR0FBQSxVQUFBLE1BQ0EsR0FBQSxTQUFBLFFBQUEsRUFBQSxHQUNBLEdBQUEsVUFBQSxTQUNBLEdBQUEsVUFBQSxVQUNBLEdBQUEsU0FBQSxJQUFBLEVBQUEsR0FDQSxHQUFBLFVBQUEsUUFDQSxHQUFBLFVBQUEsVUFDQSxHQUFBLFNBQUEsT0FBQSxFQUFBLElBSUEsUUFBQSxlQUFBLEVBQUEsR0FFQSxJQURBLEdBQUEsR0FBQSxLQUFBLEVBQUEsRUFDQSxFQUFBLEVBQUEsSUFFQSxJQURBLEVBQUEsR0FBQSxHQUFBLE9BQUEsR0FDQSxFQUFBLEVBQUEsRUFBQSxHQUFBLEVBQUEsR0FBQSxLQUFBLENBRUEsT0FBQSxHQUdBLFFBQUEsZUFBQSxFQUFBLEVBQUEsR0FJQSxJQUhBLEdBRUEsR0FGQSxFQUFBLGFBQUEsRUFBQSxFQUFBLEdBQ0EsS0FFQSxFQUFBLFFBQ0EsRUFBQSxFQUFBLE9BQUEsRUFBQSxHQUNBLEVBQUEsS0FBQSxFQUVBLE9BQUEsR0FHQSxRQUFBLGNBQUEsRUFBQSxFQUFBLEdBQ0EsR0FHQSxHQUFBLEVBSEEsRUFBQSxFQUFBLEVBQUEsTUFDQSxFQUFBLEdBQUEsT0FBQSxPQUNBLEVBQUEsR0FBQSxPQUFBLEVBRUEsS0FBQSxFQUFBLEVBQUEsTUFBQSxHQUFBLEVBQUEsS0FBQSxDQUNBLEtBQUEsRUFBQSxFQUFBLEVBQUEsR0FBQSxFQUFBLEtBQUEsQ0FFQSxPQURBLEdBQUEsRUFBQSxPQUFBLEdBQ0EsUUFBQSxHQUdBLFFBQUEsWUFBQSxFQUFBLEdBSUEsSUFIQSxHQUFBLEdBQUEsRUFBQSxHQUFBLE9BQ0EsRUFBQSxHQUFBLE9BQUEsR0FDQSxFQUFBLEVBQ0EsRUFBQSxHQUFBLEVBQUEsS0FBQSxDQUNBLE9BQUEsR0FBQSxRQUFBLEdBQUEsR0FJQSxRQUFBLFNBQUEsR0FFQSxJQURBLEdBQUEsR0FBQSxFQUFBLEVBQUEsT0FDQSxHQUNBLEVBQUEsS0FBQSxNQUFBLEtBQUEsU0FBQSxLQUNBLEVBQUEsSUFBQSxFQUFBLEdBQUEsRUFBQSxHQUFBLEVBQUEsSUFBQSxFQUVBLE9BQUEsR0FHQSxRQUFBLGtCQUNBLE1BQUEsTUFBQSxNQUFBLE1BQUEsS0FBQSxHQ2xMQSxRQUFBLFlBQ0EsU0FBQSxLQUFBLFVBQ0EsSUFBQSxjQUFBLEtBQUEsTUFDQSxJQUFBLFdBQUEsVUFBQSxVQUNBLFFBQUEsU0FBQSxFQUFBLEtBQUEsTUFDQSxVQUFBLEtBR0EsUUFBQSxXQUFBLEVBQUEsR0FDQSxHQUNBLEdBREEsRUFBQSxFQUFBLE9BQ0EsRUFBQSxFQUFBLEVBQUEsQ0FJQSxLQUhBLFVBQUEsSUFDQSxFQUFBLE1BQUEsR0FFQSxFQUFBLEVBQUEsSUFDQSxJQUFBLEVBQUEsRUFBQSxLQUFBLEVBQUEsSUFDQSxTQUFBLEVBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxFQUFBLEdBQUEsSUFLQSxRQUFBLFVBQUEsRUFBQSxFQUFBLEVBQUEsR0FDQSxHQUVBLEdBRkEsRUFBQSxFQUFBLE1BQUEsRUFDQSxFQUFBLEVBQUEsTUFBQSxFQUFBLEVBQUEsRUFDQSxFQUFBLENBR0EsS0FGQSxHQUFBLFlBQUEsS0FBQSxHQUNBLEdBQUEsVUFBQSxFQUFBLEVBQUEsRUFBQSxHQUNBLEVBQUEsRUFBQSxJQUNBLEVBQUEsRUFBQSxFQUNBLFNBQUEsRUFBQSxFQUFBLEVBQUEsRUFFQSxLQUFBLEVBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxJQUNBLEVBQUEsRUFBQSxFQUNBLFNBQUEsRUFBQSxFQUFBLEVBQUEsR0FJQSxRQUFBLFVBQUEsRUFBQSxFQUFBLEVBQUEsR0FDQSxHQUFBLFlBQ0EsR0FBQSxPQUFBLEVBQUEsR0FDQSxHQUFBLE9BQUEsRUFBQSxHQUNBLEdBQUEsU0FHQSxRQUFBLFVBQUEsRUFBQSxFQUFBLEdBQ0EsRUFBQSxVQUFBLEtBQUEsR0FDQSxFQUFBLFNBQUEsRUFBQSxFQUFBLEVBQUEsR0FHQSxRQUFBLGdCQUNBLFdBQUEsVUFDQSxXQUFBLHNCQUFBLFNBR0EsUUFBQSxXQUVBLElBREEsR0FBQSxHQUFBLEVBQUEsRUFDQSxLQUFBLEVBQUEsSUFDQSxJQUFBLEVBQUEsRUFBQSxLQUFBLEVBQUEsSUFDQSxJQUFBLEdBQUEsR0FBQSxVQUFBLEVBQUEsR0FDQSxTQUFBLEVBQUEsRUFBQSxFQUFBLEVBQUEsSUFBQSxHQUFBLEdBR0EsTUFBQSxJQUFBLElBQUEsS0FBQSxHQUNBLGFBQ0EsVUFDQSxZQUFBLFFBQ0EsV0FBQSxVQUNBLGtCQUVBLHNCQUFBLFNBR0EsWUFBQSxRQUNBLGlCQUtBLFFBQUEsa0JBQ0EsR0FDQSxHQURBLEVBQUEsSUFBQSxPQUNBLEVBQUEsQ0FJQSxLQUhBLEtBQUEsRUFDQSxRQUFBLEVBQ0EsT0FBQSxFQUNBLEVBQUEsRUFBQSxJQUNBLElBQUEsRUFBQSxFQUFBLEtBQUEsRUFBQSxJQUNBLElBQUEsR0FBQSxHQUNBLElBQUEsSUFBQSxHQUFBLEdBQ0EsVUFFQSxTQUdBLE1BS0EsVUFBQSxPQUdBLFFBQUEsV0FBQSxFQUFBLEdBbUJBLElBaEJBLEdBZUEsR0FmQSxFQUFBLEVBQUEsRUFBQSxFQUFBLEtBQUEsRUFBQSxFQUFBLEVBQ0EsRUFBQSxFQUFBLEVBQUEsS0FBQSxFQUFBLEVBQUEsRUFBQSxFQUNBLEVBQUEsRUFBQSxFQUFBLEVBQUEsS0FBQSxFQUFBLEVBQUEsRUFDQSxFQUFBLEVBQUEsRUFBQSxLQUFBLEVBQUEsRUFBQSxFQUFBLEVBRUEsR0FDQSxJQUFBLEdBQUEsR0FDQSxJQUFBLEdBQUEsR0FDQSxJQUFBLEdBQUEsR0FDQSxJQUFBLEdBQUEsR0FDQSxJQUFBLEdBQUEsR0FDQSxJQUFBLEdBQUEsR0FDQSxJQUFBLEdBQUEsR0FDQSxJQUFBLEdBQUEsSUFFQSxFQUFBLEVBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxFQUFBLEVBQ0EsRUFBQSxFQUFBLElBQ0EsRUFBQSxHQUNBLElBQUEsRUFBQSxHQUNBLElBRUEsSUFHQSxHQU1BLE9BSEEsR0FBQSxFQUFBLEVBR0EsSUFBQSxHQUFBLEdBQ0EsRUFBQSxHQUFBLEVBQUEsRUFBQSxFQUFBLElBQUEsR0FBQSxHQUdBLElBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxFQUFBLEtBQUEsTUFBQSxLQUFBLFNBQUEsSUNyR0EsUUFBQSxlQUNBLE1BQUEsS0FBQSxPQUFBLE1BQ0EsR0FBQSxLQUFBLFFBQUEsTUFDQSxRQUFBLEtBQUEsT0FBQSxNQUNBLFFBQUEsS0FBQSxTQUFBLE1BQ0EsT0FJQSxRQUFBLGVBQUEsR0FDQSxHQUFBLEdBQUEsU0FBQSxlQUFBLEVBQUEsT0FBQSxHQUFBLFFBQUEsTUFBQSxTQUNBLEVBQUEsQ0FDQSxJQUFBLFNBQUEsRUFBQSxPQUFBLGdCQUFBLENBQ0EsS0FBQSxFQUFBLFFBQUEsT0FBQSxJQUNBLFNBQUEsUUFBQSxHQUFBLGVBR0EsS0FEQSxTQUFBLEVBQUEsT0FBQSxnQkFDQSxFQUFBLEVBQUEsRUFBQSxPQUFBLE9BQUEsSUFDQSxTQUFBLE9BQUEsR0FBQSxTQUVBLFVBQUEsRUFBQSxXQUlBLFFBQUEsbUJBQ0EsVUFBQSxFQUdBLFFBQUEsbUJBQUEsR0FDQSxVQUFBLEVBQ0Esa0JBQUEsR0FHQSxRQUFBLG1CQUFBLEdBQ0EsR0FBQSxXQUFBLFVBQUEsQ0FDQSxHQUFBLEdBQUEsY0FBQSxFQUFBLE9BQUEsR0FDQSxFQUFBLEtBQUEsTUFBQSxFQUFBLEVBQUEsR0FDQSxFQUFBLEtBQUEsTUFBQSxFQUFBLEVBQUEsRUFDQSxHQUFBLEVBQUEsT0FDQSxVQUFBLElBQUEsR0FBQSxVQUFBLElBQUEsS0FDQSxVQUFBLEdBQUEsR0FBQSxVQUFBLEdBQUEsR0FBQSxFQUFBLEVBQ0EsVUFBQSxFQUFBLEVBQ0EsVUFBQSxFQUFBLEVBQ0EsVUFBQSxVQUFBLFNBRUEsRUFBQSxFQUFBLE1BQUEsSUFDQSxHQUFBLE1BQUEsR0FDQSxXQUFBLElBQUEsR0FBQSxXQUFBLElBQUEsS0FDQSxTQUFBLEdBQUEsR0FBQSxTQUFBLEdBQUEsR0FBQSxFQUFBLEVBQ0EsV0FBQSxFQUFBLEVBQ0EsV0FBQSxFQUFBLEVBQ0EsVUFBQSxTQUFBLFlBTUEsUUFBQSxjQUFBLEdBQ0EsS0FBQSxNQUFBLEVBQUEsRUFBQSxHQUNBLEtBQUEsTUFBQSxFQUFBLEVBQUEsR0FHQSxRQUFBLFVBQUEsRUFBQSxHQUNBLE9BQUEsSUFBQSxFQUFBLFVBQUEsS0FBQSxRQUFBLElBQUEsRUFBQSxLQUFBLEdBR0EsUUFBQSxVQUFBLEVBQUEsR0FDQSxTQUFBLEVBQUEsS0FDQSxFQUFBLFdBQUEsSUFBQSxHQUdBLFFBQUEsVUFBQSxFQUFBLEdBQ0EsRUFBQSxVQUFBLEVBQUEsVUFBQSxRQUFBLElBQUEsRUFBQSxJQUdBLFFBQUEsZUFBQSxFQUFBLEdBQ0EsR0FBQSxHQUFBLEVBQUEsdUJBQ0EsUUFDQSxFQUFBLEVBQUEsTUFBQSxFQUFBLEtBQ0EsRUFBQSxFQUFBLE1BQUEsRUFBQSxLQUlBLFFBQUEsYUFBQSxFQUFBLEdBQ0EsTUFBQSxTQUFBLEVBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxFQUFBLEVBQUEsSUFBQSxRQUFBLEVBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxFQUFBLEVBQUEsR0FHQSxRQUFBLFNBQUEsRUFBQSxFQUFBLEdBQ0EsTUFBQSxJQUFBLEtBQUEsSUFBQSxFQUFBLElBQUEsR0FBQSxLQUFBLElBQUEsRUFBQSxHRjdIQSxHQUFBLE1BQUEsR0FDQSxFQUFBLEdBQ0EsRUFDQSxLQUNBLFVBQ0EsU0FDQSxTQUNBLFFBQ0EsV0FDQSxXQUNBLE1BQ0EsRUFBQSxFQUFBLEdBQUEsR0FBQSxNQUFBLE1BQUEsT0FDQSxNQUFBLFVBQUEsVUFBQSxVQUFBLGlCQUNBLFdBQUEsRUFDQSxRQUFBLEVBQ0EsV0FDQSxFQUFBLElBQ0EsRUFBQSxLQUVBLFlBQ0EsRUFBQSxJQUNBLEVBQUEsS0FFQSxTQUNBLFFBQ0EsT0FDQSxLQUNBLFdBV0EsS0FBQSxNQUFBLFNBQ0EsS0FBQSxNQUFBLFNBQ0EsS0FBQSxNQUFBLFNBQ0EsTUFBQSxNQUFBLFVBQ0EsU0FBQSxNQUFBLGNBQ0EsVUFBQSxNQUFBLGVBQ0EsUUFBQSxTQUFBLHVCQUFBLE9BQ0EsT0FBQSxTQUFBLHVCQUFBLFVBQ0EsS0FBQSxTQUFBLE1BQUEsR0FDQSxFQUFBLEtBQUEsV0FBQSxNQUNBLEdBQUEsS0FBQSxXQUFBLE1BQ0EsRUFBQSxTQUFBLEtBQ0EsUUFBQSxPQUFBLFdBQ0EsUUFBQSxPQUFBLFlBQ0EsU0FDQSxXQUFBLFVFckRBLEdBQUEsUUFBQSxTQUFBLEdBRUEsT0FBQSxFQUFBLFNBQ0EsSUFBQSxJQUFBLGNBQUEsTUFDQSxLQUFBLElBQUEsV0FBQSxNQUFBLEVBQUEsTUFDQSxLQUFBLElBQUEsV0FBQSxTQUFBLE1BQ0EsS0FBQSxJQUFBLFdBQUEsU0FBQSxNQUNBLEtBQUEsSUFBQSxXQUFBLFNBQUEsTUFDQSxLQUFBLElBQUEsV0FBQSxZQUlBLEVBQUEsVUFBQSxTQUFBLEdBQ0EsR0FBQSxTQUFBLEVBQUEsT0FBQSxTQUNBLGNBQUEsT0FFQSxJQUFBLFdBQUEsRUFBQSxPQUFBLFNBQ0EsZ0JBQUEsT0FDQSxJQUFBLFFBQUEsRUFBQSxPQUFBLFNBQ0EsT0FBQSxFQUFBLE9BQUEsSUFDQSxJQUFBLFFBQUEsYUFBQSxNQUNBLEtBQUEsUUFBQSxVQUFBLE1BQ0EsS0FBQSxXQUNBLFVBQUEsY0FBQSxNQUFBLEtBQUEsR0FDQSxVQUFBLFdBQUEsRUFDQSxNQUNBLEtBQUEsUUFDQSxVQUFBLGNBQUEsTUFBQSxNQUNBLFVBQUEsV0FBQSxFQUNBLE1BQ0EsU0FBQSxPQUFBLElBSUEsS0FBQSxZQUFBLGtCQUNBLEtBQUEsWUFBQSxrQkE2RkEiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgY29sTiA9IDUxLCAgIC8vIGluaXRpYWwgbnVtYmVyIG9mIGNvbHVtbnNcclxuICAgIFAgPSAwLjUsICAgIC8vIGRlbnNpdHkgb2YgdGhlIHBvcHVsYXRpb25cclxuICAgIFMsICAgICAgICAgIC8vIGNlbGwncyBzaXplXHJcbiAgICByb3dOLFxyXG4gICAgcGxheWVyQXJyLFxyXG4gICAgcGxheWVyTEMsXHJcbiAgICBlbmVteUFycixcclxuICAgIGVuZW15TEMsICAgICAgICAgLy8gbnVtYmVyIG9mIHJvd3NcclxuICAgIGJhdHRsZUFycjEsICAgICAgICAgIC8vIGFycmF5IHRvIGtlZXAgc3RhdGUgb2YgZWFjaCBjZWxsXHJcbiAgICBiYXR0bGVBcnIyLFxyXG4gICAgbWF4TNChLFxyXG4gICAgVywgSCwgZFcsIGRILCBoYWxmVywgY29sSE4sIG1heEdlbixcclxuICAgIENMUlMgPSBbXCIjNUExRjAwXCIsIFwiI0QxNTcwRFwiLFwiIzQ3NzcyNVwiLCBcInJnYmEoMCwwLDAsMSlcIl0sXHJcbiAgICBhbmltYXRpb24gPSBmYWxzZSwgLy8gbWFyayB0aGF0IGFuaW1hdGlvbidzIG9uXHJcbiAgICBncmlkT24gPSB0cnVlLFxyXG4gICAg0YFlbGxDYWNoZSA9IHtcclxuICAgICAgICBpOiAxMDAwLFxyXG4gICAgICAgIGo6IDEwMDBcclxuICAgIH0sXHJcbiAgICDRgWVsbENhY2hlMSA9IHtcclxuICAgICAgICBpOiAxMDAwLFxyXG4gICAgICAgIGo6IDEwMDBcclxuICAgIH0sXHJcbiAgICBkcmFnZ2luZyxcclxuICAgIG9yYW5nZXMsXHJcbiAgICBncmVlbnMsXHJcbiAgICBkZWFkLFxyXG4gICAgZ2VuZXJhdGlvbjtcclxuLy8gQTlDQzY2XHJcbi8vIDQ3NzcyNStcclxuLy8gRkRFNzkyXHJcbi8vIEQxNTcwRCtcclxuLy8gNUExRjAwK1xyXG5mdW5jdGlvbiBnZXRFbChzKSB7XHJcbiAgICByZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzKTtcclxuXHJcbn1cclxuXHJcbnZhciBnYW1lID0gZ2V0RWwoXCIjZ2FtZVwiKSxcclxuICAgIGdyaWQgPSBnZXRFbChcIiNncmlkXCIpLFxyXG4gICAgcGFuZSA9IGdldEVsKFwiI3BhbmVcIiksXHJcbiAgICBhcHBseSA9IGdldEVsKFwiI2FwcGx5XCIpLFxyXG4gICAgcnVsZXNCdG4gPSBnZXRFbChcIiNuYXYtcnVsZXNcIiksXHJcbiAgICBvcHRpb25CdG4gPSBnZXRFbChcIiNuYXYtb3B0aW9uXCIpLFxyXG4gICAgbmF2YnRucyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoXCJidG5cIiksXHJcbiAgICBwYW5lbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFwicGFuZWxzXCIpLFxyXG4gICAgZm9ybSA9IGRvY3VtZW50LmZvcm1zWzBdLFxyXG4gICAgYyA9IGdhbWUuZ2V0Q29udGV4dChcIjJkXCIpLFxyXG4gICAgZ9GBID0gZ3JpZC5nZXRDb250ZXh0KFwiMmRcIiksXHJcbiAgICBiID0gZG9jdW1lbnQuYm9keSxcclxuICAgIHdpbmRvd1cgPSB3aW5kb3cuaW5uZXJXaWR0aCxcclxuICAgIHdpbmRvd0ggPSB3aW5kb3cuaW5uZXJIZWlnaHQsXHJcbiAgICBpbmZvcm1lcixcclxuICAgIGJhdHRsZUFycjEsIGJhdHRsZUFycjI7XHJcblxyXG5mdW5jdGlvbiBpbml0KHNob3dwYW5lbCkge1xyXG4gICAgZ2VuZXJhdGlvbiA9IDA7XHJcbiAgICBvcmFuZ2VzID0gMDtcclxuICAgIGdyZWVucyA9IDA7XHJcbiAgICBkZWFkID0gMDtcclxuICAgIG1heEdlbiA9ICtmb3JtLmdlbm51bS52YWx1ZTtcclxuICAgIFMgPSBNYXRoLmZsb29yKHdpbmRvd1cvY29sTik7XHJcbiAgICByb3dOID0gTWF0aC5mbG9vcih3aW5kb3dIL1MpO1xyXG4gICAgVyA9IFMgKiBjb2xOO1xyXG4gICAgSCA9IFMgKiByb3dOO1xyXG4gICAgZFcgPSAod2luZG93VyAtIFcpLzI7XHJcbiAgICBkSCA9ICh3aW5kb3dIIC0gSCkvMjtcclxuICAgIGNvbEhOID0oY29sTiAtIDEpLzI7XHJcbiAgICBoYWxmVyA9IFMgKiBjb2xITjtcclxuICAgIG1heEzQoSA9IGdldENlbGxzTnVtYmVyKCk7XHJcbiAgICBpbmZvcm1lciA9IG5ldyBJbmZvcm1lcigpO1xyXG5cclxuICAgIGdhbWUud2lkdGggPSBXO1xyXG4gICAgZ2FtZS5oZWlnaHQgPSBIO1xyXG4gICAgZ3JpZC53aWR0aCA9IFc7XHJcbiAgICBncmlkLmhlaWdodCA9IEg7XHJcbiAgICBnYW1lLnN0eWxlLmxlZnQgPSBkVyArIFwicHhcIjtcclxuICAgIGdhbWUuc3R5bGUudG9wID0gZEggKyBcInB4XCI7XHJcbiAgICBncmlkLnN0eWxlLmxlZnQgPSBkVyArIFwicHhcIjtcclxuICAgIGdyaWQuc3R5bGUudG9wID0gZEggKyBcInB4XCI7XHJcblxyXG4gICAgcGFuZS5zdHlsZS50b3AgPSBkSCArIFwicHhcIjtcclxuICAgIHBhbmUuc3R5bGUucmlnaHQgPSBkVyArIFwicHhcIjtcclxuICAgIHBhbmUuc3R5bGUud2lkdGggPSBoYWxmVyArIFwicHhcIjtcclxuICAgIHBhbmUuc3R5bGUuaGVpZ2h0ID0gSCArIFwicHhcIjtcclxuICAgIGZvcm0ubGl2ZWNlbGxzLnZhbHVlID0gbWF4TNChO1xyXG5cclxuICAgIHBsYXllckFyciA9IGdldEVtcHR5QXJyYXkoY29sSE4sIHJvd04pO1xyXG4gICAgZW5lbXlBcnIgPSBnZXRUcmliZUFycmF5KGNvbEhOLCByb3dOLCAyKTtcclxuXHJcbiAgICBkcmF3U3RhZ2UocGxheWVyQXJyLCB0cnVlKTtcclxuICAgIGlmICggZ3JpZE9uICkgeyBkcmF3R3JpZChTLCBjb2xOLCByb3dOLCB0cnVlKTsgfVxyXG4gICAgaWYgKCBzaG93cGFuZWwgKSB7IHJlbUNsYXNzKHBhbmUsIFwiaGlkZGVuXCIpOyB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIEluZm9ybWVyKCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzLFxyXG4gICAgICAgIHcgPSBXLzQsXHJcbiAgICAgICAgaCA9IEgvOCxcclxuICAgICAgICBmcyA9IGgvMS4yLFxyXG4gICAgICAgIHJlY3RYID0gKFcgLSB3KS8yLFxyXG4gICAgICAgIHJlY3RZID0gKEggLSBoKS8yLFxyXG4gICAgICAgIHRleHRYMiA9IHJlY3RYICsgdy8yLFxyXG4gICAgICAgIHRleHRYMSA9IHRleHRYMiAtIHcvMTAsXHJcbiAgICAgICAgdGV4dFgzID0gdGV4dFgyICsgdy8xMCxcclxuICAgICAgICB0ZXh0WSA9IHJlY3RZICsgaC8yO1xyXG5cclxuXHJcbiAgICBzZWxmLmRyYXcgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgZ9GBLmZvbnQgPSBmcyArIFwicHggZmFudGFzeVwiO1xyXG4gICAgICAgIGfRgS50ZXh0QmFzZWxpbmUgPSBcIm1pZGRsZVwiO1xyXG4gICAgICAgIGfRgS5maWxsU3R5bGUgPSBcIiM1QTFGMDBcIjtcclxuICAgICAgICBn0YEubGluZVdpZHRoID0gNTtcclxuICAgICAgICBn0YEuc3Ryb2tlU3R5bGUgPSBcIiNGREU3OTJcIjtcclxuICAgICAgICBn0YEuZmlsbFJlY3QocmVjdFgsIHJlY3RZLCB3LCBoKTtcclxuICAgICAgICBn0YEuc3Ryb2tlUmVjdChyZWN0WCwgcmVjdFksIHcsIGgpO1xyXG4gICAgICAgIGfRgS5maWxsU3R5bGUgPSBcIiNEMTU3MERcIjtcclxuICAgICAgICBn0YEudGV4dEFsaWduID0gXCJlbmRcIjtcclxuICAgICAgICBn0YEuZmlsbFRleHQob3JhbmdlcywgdGV4dFgxLCB0ZXh0WSk7XHJcbiAgICAgICAgZ9GBLnRleHRBbGlnbiA9IFwiY2VudGVyXCI7XHJcbiAgICAgICAgZ9GBLmZpbGxTdHlsZSA9IFwiI0ZERTc5MlwiO1xyXG4gICAgICAgIGfRgS5maWxsVGV4dChcIjpcIiwgdGV4dFgyLCB0ZXh0WSk7XHJcbiAgICAgICAgZ9GBLnRleHRBbGlnbiA9IFwic3RhcnRcIjtcclxuICAgICAgICBn0YEuZmlsbFN0eWxlID0gXCIjNDc3NzI1XCI7XHJcbiAgICAgICAgZ9GBLmZpbGxUZXh0KGdyZWVucywgdGV4dFgzLCB0ZXh0WSk7XHJcbiAgICB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRFbXB0eUFycmF5KGNvbCwgcm93KSB7XHJcbiAgICB2YXIgYXJyID0gW10sIGkgPSAwLCBqO1xyXG4gICAgZm9yICggOyBpIDwgY29sOyBpKysgKSB7XHJcbiAgICAgICAgYXJyW2ldID0gbmV3IEFycmF5KHJvdyk7XHJcbiAgICAgICAgZm9yICggaiA9IDA7IGogPCByb3c7ICkgeyBhcnJbaV1baisrXSA9IDA7IH1cclxuICAgIH1cclxuICAgIHJldHVybiBhcnI7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFRyaWJlQXJyYXkoY29sLCByb3csIGNmaWxsKSB7XHJcbiAgICB2YXIgaW5pdGFyciA9IGdldEluaXRBcnJheShjb2wsIHJvdywgY2ZpbGwpLFxyXG4gICAgICAgIGFyciA9IFtdLFxyXG4gICAgICAgIGNvbGFycjtcclxuICAgIHdoaWxlICggaW5pdGFyci5sZW5ndGggKSB7XHJcbiAgICAgICAgY29sYXJyID0gaW5pdGFyci5zcGxpY2UoMCwgcm93KTtcclxuICAgICAgICBhcnIucHVzaChjb2xhcnIpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGFycjtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0SW5pdEFycmF5KGNvbCwgcm93LCBjZmlsbCkge1xyXG4gICAgdmFyIGVtcHR5ID0gKGNvbCAqIHJvdykgLSBtYXhM0KEsXHJcbiAgICAgICAgZmlsbGVkID0gbmV3IEFycmF5KG1heEzQoSksXHJcbiAgICAgICAgemVyb3MgPSBuZXcgQXJyYXkoZW1wdHkpLFxyXG4gICAgICAgIGFyciwgaTtcclxuICAgIGZvciAoIGkgPSAwOyBpIDwgbWF4TNChOyApIHsgZmlsbGVkW2krK10gPSBjZmlsbDsgfVxyXG4gICAgZm9yICggaSA9IDA7IGkgPCBlbXB0eTsgKSB7IHplcm9zW2krK10gPSAwOyB9XHJcbiAgICBhcnIgPSBmaWxsZWQuY29uY2F0KHplcm9zKTtcclxuICAgIHJldHVybiBzaHVmZmxlKGFycik7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGpvaW5BcnJheXMoYSwgYikge1xyXG4gICAgdmFyIGxlbiA9IGFbMF0ubGVuZ3RoLFxyXG4gICAgICAgIG1pZCA9IG5ldyBBcnJheShsZW4pLFxyXG4gICAgICAgIGogPSAwO1xyXG4gICAgZm9yICggOyBqIDwgbGVuOyApIHsgbWlkW2orK10gPSAwOyB9XHJcbiAgICByZXR1cm4gYS5jb25jYXQoW21pZF0sIGIpO1xyXG59XHJcblxyXG4vLyBUaGUgRmlzaGVyLVlhdGVzIChLbnV0aCkgc2h1ZmZsZSBhbGdvcml0aG1cclxuZnVuY3Rpb24gc2h1ZmZsZShhcnIpIHtcclxuICAgIHZhciBpID0gYXJyLmxlbmd0aCwgcmFuZGk7XHJcbiAgICB3aGlsZSAoIGkgKSB7XHJcbiAgICAgICAgcmFuZGkgPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAoaS0tKSk7XHJcbiAgICAgICAgYXJyW2ldID0gW2FycltyYW5kaV0sIGFycltyYW5kaV0gPSBhcnJbaV1dWzBdO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGFycjtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0Q2VsbHNOdW1iZXIoKSB7XHJcbiAgICByZXR1cm4gTWF0aC5mbG9vcihjb2xITiAqIHJvd04gKiBQKTtcclxufSIsImZ1bmN0aW9uIGdhbWVJbml0KCkge1xyXG4gICAgYWRkQ2xhc3MocGFuZSwgXCJoaWRkZW5cIik7XHJcbiAgICBiZjEgPSBnZXRFbXB0eUFycmF5KGNvbE4sIHJvd04pO1xyXG4gICAgYmYyID0gam9pbkFycmF5cyhwbGF5ZXJBcnIsIGVuZW15QXJyKTtcclxuICAgIGlmICggZ3JpZE9uICkgeyBkcmF3R3JpZChTLCBjb2xOLCByb3dOICk7IH1cclxuICAgIGRyYXdTdGFnZShiZjIpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBkcmF3U3RhZ2UoYXJyLCBoYWxmKSB7XHJcbiAgICB2YXIgbGVuID0gYXJyLmxlbmd0aCxcclxuICAgICAgICBpID0gMCwgaiwgYWRkID0gMDtcclxuICAgIGlmICggaGFsZiA9PT0gXCJyaWdodFwiICkge1xyXG4gICAgICAgIGFkZCA9IGhhbGZXICsgUztcclxuICAgIH1cclxuICAgIGZvciAoIDsgaSA8IGxlbjsgaSsrICkge1xyXG4gICAgICAgIGZvciAoIGogPSAwOyBqIDwgcm93TjsgaisrICkge1xyXG4gICAgICAgICAgICBkcmF3Q2VsbChhZGQgKyBpKlMsIGoqUywgYXJyW2ldW2pdKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRyYXdHcmlkKHMsIG53LCBuaCwgaGFsZikge1xyXG4gICAgdmFyIHcgPSAoIGhhbGYgKSA/IGhhbGZXIDogVyxcclxuICAgICAgICBud2ggPSAoIGhhbGYgKSA/IGNvbEhOICsgMSA6IG53ICsgMSxcclxuICAgICAgICBtLCBpID0gMDtcclxuICAgIGfRgS5zdHJva2VTdHlsZSA9IENMUlNbM107XHJcbiAgICBn0YEuY2xlYXJSZWN0KDAsIDAsIFcsIEgpO1xyXG4gICAgZm9yICggOyBpIDwgbndoOyBpKysgKSB7XHJcbiAgICAgICAgbSA9IGkgKiBzO1xyXG4gICAgICAgIGRyYXdMaW5lKG0sIDAsIG0sIEgpO1xyXG4gICAgfVxyXG4gICAgZm9yICggaSA9IDA7IGkgPCBuaCArIDE7IGkrKyApIHtcclxuICAgICAgICBtID0gaSAqIHM7XHJcbiAgICAgICAgZHJhd0xpbmUoMCwgbSwgdywgbSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRyYXdMaW5lKHN4LCBzeSwgZngsIGZ5KSB7XHJcbiAgICBn0YEuYmVnaW5QYXRoKCk7XHJcbiAgICBn0YEubW92ZVRvKHN4LCBzeSk7XHJcbiAgICBn0YEubGluZVRvKGZ4LCBmeSk7XHJcbiAgICBn0YEuc3Ryb2tlKCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGRyYXdDZWxsKHgsIHksIHQpIHtcclxuICAgIGMuZmlsbFN0eWxlID0gQ0xSU1t0XTtcclxuICAgIGMuZmlsbFJlY3QoeCwgeSwgUywgUyk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNob3dNdXN0R29PbigpIHtcclxuICAgIGFuaW1hdGlvbiA9ICFhbmltYXRpb247XHJcbiAgICBpZiAoIGFuaW1hdGlvbiApIHsgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKG5leHRHZW4pOyB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG5leHRHZW4oKSB7XHJcbiAgICB2YXIgaSA9IDAsIGo7XHJcbiAgICBmb3IgKCA7IGkgPCBjb2xOOyBpKysgKSB7XHJcbiAgICAgICAgZm9yICggaiA9IDA7IGogPCByb3dOOyBqKysgKSB7XHJcbiAgICAgICAgICAgIGJmMVtpXVtqXSA9IGNhbGNTdGF0ZShpLCBqKTtcclxuICAgICAgICAgICAgZHJhd0NlbGwoaSpTLCBqKlMsIGJmMVtpXVtqXSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgYmYxID0gW2JmMiwgYmYyID0gYmYxXVswXTsgICAvLyBzd2FwIHRoZSBhcnJheXNcclxuICAgIGdlbmVyYXRpb24rKztcclxuICAgIGlmICggYW5pbWF0aW9uICkge1xyXG4gICAgICAgIGlmICggZ2VuZXJhdGlvbiA+PSBtYXhHZW4gKSB7XHJcbiAgICAgICAgICAgIGFuaW1hdGlvbiA9ICFhbmltYXRpb247XHJcbiAgICAgICAgICAgIGRpc3BsYXlSZXN1bHRzKCk7XHJcbiAgICAgICAgfWVsc2Uge1xyXG4gICAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUobmV4dEdlbik7XHJcbiAgICAgICAgfVxyXG4gICAgfWVsc2Uge1xyXG4gICAgICAgIGlmICggZ2VuZXJhdGlvbiA+PSBtYXhHZW4gKSB7XHJcbiAgICAgICAgICAgIGRpc3BsYXlSZXN1bHRzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBkaXNwbGF5UmVzdWx0cygpIHtcclxuICAgIHZhciBsZW4gPSBiZjIubGVuZ3RoLFxyXG4gICAgICAgIGkgPSAwLCBqO1xyXG4gICAgZGVhZCA9IDA7XHJcbiAgICBvcmFuZ2VzID0gMDtcclxuICAgIGdyZWVucyA9IDA7XHJcbiAgICBmb3IgKCA7IGkgPCBsZW47IGkrKyApIHtcclxuICAgICAgICBmb3IgKCBqID0gMDsgaiA8IHJvd047IGorKyApIHtcclxuICAgICAgICAgICAgaWYgKCBiZjJbaV1bal0gKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIGJmMltpXVtqXSA9PT0gMSApIHtcclxuICAgICAgICAgICAgICAgICAgICBvcmFuZ2VzKys7XHJcbiAgICAgICAgICAgICAgICB9ZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZ3JlZW5zKys7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1lbHNlIHtcclxuICAgICAgICAgICAgICAgIGRlYWQrKztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBpbmZvcm1lci5kcmF3KCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNhbGNTdGF0ZShpLGopIHtcclxuXHJcbiAgICAvLyBUaGUgYmF0dGxlZmllbGQgZXNzZW50aWFsbHkgaXMgYSB0b3J1cy5cclxuICAgIHZhciBtaSA9ICggaS0xIDwgMCApID8gY29sTi0xIDogaS0xLFxyXG4gICAgICAgIHBpID0gKCBpKzEgPiBjb2xOLTEgKSA/IDAgOiBpKzEsXHJcbiAgICAgICAgbWogPSAoIGotMSA8IDAgKSA/IHJvd04tMSA6IGotMSxcclxuICAgICAgICBwaiA9ICggaisxID4gcm93Ti0xICkgPyAwIDogaisxLFxyXG4gICAgLy8gYWxsIHRoZSBuZWlnaGJvdXJzIGFyZSB3ZWxjb21lIHRvIHRoZSBzcGVjaWFsIGFycmF5XHJcbiAgICAgICAgbmVpZ2hib3VycyA9IFtcclxuICAgICAgICAgICAgYmYyW21pXVttal0sXHJcbiAgICAgICAgICAgIGJmMlttaV1bal0sXHJcbiAgICAgICAgICAgIGJmMlttaV1bcGpdLFxyXG4gICAgICAgICAgICBiZjJbaV1bbWpdLFxyXG4gICAgICAgICAgICBiZjJbaV1bcGpdLFxyXG4gICAgICAgICAgICBiZjJbcGldW21qXSxcclxuICAgICAgICAgICAgYmYyW3BpXVtqXSxcclxuICAgICAgICAgICAgYmYyW3BpXVtwal1cclxuICAgICAgICBdLFxyXG4gICAgICAgIHplcnJvID0gMCwgb25lcyA9IDAsIHR3b3MgPSAwLCB6ID0gMCwgYWxpdmU7XHJcbiAgICBmb3IgKCA7IHo8ODsgeisrICkge1xyXG4gICAgICAgIGlmICggbmVpZ2hib3Vyc1t6XSApIHtcclxuICAgICAgICAgICAgaWYgKCBuZWlnaGJvdXJzW3pdPT09MSApIHtcclxuICAgICAgICAgICAgICAgIG9uZXMrKztcclxuICAgICAgICAgICAgfWVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdHdvcysrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfWVsc2Uge1xyXG4gICAgICAgICAgICB6ZXJybysrO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGFsaXZlID0gb25lcyArIHR3b3M7XHJcbiAgICAvLyB1c3VhbCBydWxlcyBvZiB0aGUgQ29ud2F5J3MgR2FtZSBPZiBMaWZlXHJcblxyXG4gICAgaWYgKCBiZjJbaV1bal0gKSB7XHJcbiAgICAgICAgcmV0dXJuICggYWxpdmU8MiB8fCBhbGl2ZT4zICkgPyAwIDogYmYyW2ldW2pdO1xyXG4gICAgfVxyXG4gICAgLy9idXQgaWYgdGhlIGRlYWQgY2VsbCB3YXMgbWFkZSB0byBjYW1lIHRvIGxpZmUsIGl0IGFwcGVhcnMgYXMgYSBtZW1iZXIgb2YgdGhlIHByZWRvbWluYW50IChpbiB0aGUgbmVpZ2hib3VyaG9vZCkgdHJpYmVcclxuICAgIHJldHVybiAoIGFsaXZlIT09MyApID8gMCA6ICggdHdvcyA+IG9uZXMgKSA/IDIgOiAoIG9uZXMgPiB0d29zICkgPyAxIDogKE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSswLjUpKTtcclxufSIsImIub25rZXl1cCA9IGZ1bmN0aW9uKGUpIHtcclxuICAgIGNvbnNvbGUubG9nKGUua2V5Q29kZSk7XHJcbiAgICBzd2l0Y2ggKGUua2V5Q29kZSkge1xyXG4gICAgICAgIGNhc2UgMzI6IHNob3dNdXN0R29PbigpOyBicmVhaztcclxuICAgICAgICBjYXNlIDI3OiBpZiAoICFhbmltYXRpb24gKSB7IGluaXQodHJ1ZSk7IH0gYnJlYWs7XHJcbiAgICAgICAgY2FzZSAzOTogaWYgKCAhYW5pbWF0aW9uICkgeyBuZXh0R2VuKCk7IH0gYnJlYWs7XHJcbiAgICAgICAgY2FzZSAzNzogaWYgKCAhYW5pbWF0aW9uICkgeyBuZXh0R2VuKCk7IH0gYnJlYWs7XHJcbiAgICAgICAgY2FzZSAzODogaWYgKCAhYW5pbWF0aW9uICkgeyBuZXh0R2VuKCk7IH0gYnJlYWs7XHJcbiAgICAgICAgY2FzZSA0MDogaWYgKCAhYW5pbWF0aW9uICkgeyBuZXh0R2VuKCk7IH0gYnJlYWs7XHJcbiAgICB9XHJcbn07XHJcblxyXG5iLm9ubW91c2V1cCA9IGZ1bmN0aW9uKGUpIHtcclxuICAgIGlmICggZS50YXJnZXQubm9kZU5hbWUgPT09IFwiU1BBTlwiICkge1xyXG4gICAgICAgIG9uU3Bhbk1vdXNlVXAoZSk7XHJcblxyXG4gICAgfWVsc2UgaWYgKCBlLnRhcmdldC5ub2RlTmFtZSA9PT0gXCJDQU5WQVNcIiApIHtcclxuICAgICAgICBvbkNhbnZhc01vdXNlVXAoZSk7XHJcbiAgICB9ZWxzZSBpZiAoIGUudGFyZ2V0Lm5vZGVOYW1lID09PSBcIkRJVlwiICkge1xyXG4gICAgICAgIHN3aXRjaCAoIGUudGFyZ2V0LmlkICkge1xyXG4gICAgICAgICAgICBjYXNlIFwiYXBwbHlcIjogIGFwcGx5Q29uZmlnKCk7IGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwic3RhcnRcIjogIGdhbWVJbml0KCk7IGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlIFwiZ2VuZXJhdGVcIjpcclxuICAgICAgICAgICAgICAgIHBsYXllckFyciA9IGdldFRyaWJlQXJyYXkoY29sSE4sIHJvd04sIDEpO1xyXG4gICAgICAgICAgICAgICAgZHJhd1N0YWdlKHBsYXllckFyciwgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcInJlc2V0XCI6XHJcbiAgICAgICAgICAgICAgICBwbGF5ZXJBcnIgPSBnZXRFbXB0eUFycmF5KGNvbEhOLCByb3dOKTtcclxuICAgICAgICAgICAgICAgIGRyYXdTdGFnZShwbGF5ZXJBcnIsIHRydWUpO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6ICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59O1xyXG5ncmlkLm9ubW91c2Vkb3duID0gb25DYW52YXNNb3VzZURvd247XHJcbmdyaWQub25tb3VzZW1vdmUgPSBvbkNhbnZhc01vdXNlTW92ZTtcclxuXHJcbmZ1bmN0aW9uIGFwcGx5Q29uZmlnKGUpIHtcclxuICAgIGNvbE4gPSArZm9ybS5jb2xudW0udmFsdWU7XHJcbiAgICBQID0gK2Zvcm0ucG9wZGVucy52YWx1ZTtcclxuICAgIG1heEdlbiA9ICtmb3JtLmdlbm51bS52YWx1ZTtcclxuICAgIGdyaWRPbiA9ICtmb3JtLnNob3dncmlkLnZhbHVlO1xyXG4gICAgaW5pdCgpO1xyXG5cclxufVxyXG5cclxuZnVuY3Rpb24gb25TcGFuTW91c2VVcChlKSB7XHJcbiAgICB2YXIgcGFuZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChlLnRhcmdldC5pZC5yZXBsYWNlKFwibmF2XCIsIFwicGFuZVwiKSksXHJcbiAgICAgICAgaSA9IDA7XHJcbiAgICBpZiAoIGhhc0NsYXNzKGUudGFyZ2V0LCBcImluYWN0aXZlLWJ0blwiKSApIHtcclxuICAgICAgICBmb3IgKCA7IGkgPCBuYXZidG5zLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhuYXZidG5zW2ldLCBcImluYWN0aXZlLWJ0blwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVtQ2xhc3MoZS50YXJnZXQsIFwiaW5hY3RpdmUtYnRuXCIpO1xyXG4gICAgICAgIGZvciAoIGkgPSAwOyBpIDwgcGFuZWxzLmxlbmd0aDsgaSsrICkge1xyXG4gICAgICAgICAgICBhZGRDbGFzcyhwYW5lbHNbaV0sIFwiaGlkZGVuXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZW1DbGFzcyhwYW5lbCwgXCJoaWRkZW5cIik7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG9uQ2FudmFzTW91c2VVcChlKSB7XHJcbiAgICBkcmFnZ2luZyA9IGZhbHNlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBvbkNhbnZhc01vdXNlRG93bihlKSB7XHJcbiAgICBkcmFnZ2luZyA9IHRydWU7XHJcbiAgICBvbkNhbnZhc01vdXNlTW92ZShlKTtcclxufVxyXG5cclxuZnVuY3Rpb24gb25DYW52YXNNb3VzZU1vdmUoZSkge1xyXG4gICAgaWYgKCBkcmFnZ2luZyAmJiAhYW5pbWF0aW9uICkge1xyXG4gICAgICAgIHZhciBtb3VzZSA9IGdldFBvaW50ZXJQb3MoZS50YXJnZXQsIGUpLFxyXG4gICAgICAgICAgICBpID0gTWF0aC5mbG9vcihtb3VzZS54L1MpLFxyXG4gICAgICAgICAgICBqID0gTWF0aC5mbG9vcihtb3VzZS55L1MpO1xyXG4gICAgICAgIGlmICggbW91c2UueCA8IGhhbGZXICkge1xyXG4gICAgICAgICAgICBpZiAoICEo0YFlbGxDYWNoZS5pID09PSBpICYmINGBZWxsQ2FjaGUuaiA9PT0gaikgKSB7XHJcbiAgICAgICAgICAgICAgICBwbGF5ZXJBcnJbaV1bal0gPSAoIHBsYXllckFycltpXVtqXSApID8gMCA6IDE7XHJcbiAgICAgICAgICAgICAgICDRgWVsbENhY2hlLmkgPSBpO1xyXG4gICAgICAgICAgICAgICAg0YFlbGxDYWNoZS5qID0gajtcclxuICAgICAgICAgICAgICAgIGRyYXdTdGFnZShwbGF5ZXJBcnIsIFwibGVmdFwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1lbHNlIGlmICggbW91c2UueCA+IGhhbGZXICsgUyApIHtcclxuICAgICAgICAgICAgaSAtPSBjb2xITiArIDE7XHJcbiAgICAgICAgICAgIGlmICggISjRgWVsbENhY2hlMS5pID09PSBpICYmINGBZWxsQ2FjaGUxLmogPT09IGopICkge1xyXG4gICAgICAgICAgICAgICAgZW5lbXlBcnJbaV1bal0gPSAoIGVuZW15QXJyW2ldW2pdICkgPyAwIDogMjtcclxuICAgICAgICAgICAgICAgINGBZWxsQ2FjaGUxLmkgPSBpO1xyXG4gICAgICAgICAgICAgICAg0YFlbGxDYWNoZTEuaiA9IGo7XHJcbiAgICAgICAgICAgICAgICBkcmF3U3RhZ2UoZW5lbXlBcnIsIFwicmlnaHRcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldENlbGxDb29yZChtb3VzZSkge1xyXG4gICAgdmFyIGkgPSBNYXRoLnJvdW5kKG1vdXNlLngvUyksXHJcbiAgICAgICAgaiA9IE1hdGgucm91bmQobW91c2UueS9TKTtcclxufVxyXG5cclxuZnVuY3Rpb24gaGFzQ2xhc3MoZWwsIGNscykge1xyXG4gICAgcmV0dXJuIChcIiBcIiArIGVsLmNsYXNzTmFtZSArIFwiIFwiKS5pbmRleE9mKFwiIFwiICsgY2xzICsgXCIgXCIpID4gLTE7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGFkZENsYXNzKGVsLCBjbHMpIHtcclxuICAgIGlmICggaGFzQ2xhc3MoZWwsIGNscykgKSB7IHJldHVybjsgfVxyXG4gICAgZWwuY2xhc3NOYW1lICs9IFwiIFwiICsgY2xzO1xyXG59XHJcblxyXG5mdW5jdGlvbiByZW1DbGFzcyhlbCwgY2xzKSB7XHJcbiAgICBlbC5jbGFzc05hbWUgPSBlbC5jbGFzc05hbWUucmVwbGFjZShcIiBcIiArIGNscywgXCJcIik7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFBvaW50ZXJQb3MoYywgZSkge1xyXG4gICAgdmFyIGJjciA9IGMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIHg6IGUucGFnZVggLSBiY3IubGVmdCxcclxuICAgICAgICB5OiBlLnBhZ2VZIC0gYmNyLnRvcFxyXG4gICAgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gcG9pbnRJblJlY3QgKHBvaW50LCByZWN0KSB7XHJcbiAgICByZXR1cm4gaW5SYW5nZShwb2ludC54LCByZWN0LngsIHJlY3QueCArIHJlY3QudykgJiYgaW5SYW5nZShwb2ludC55LCByZWN0LnksIHJlY3QueSArIHJlY3QuaCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGluUmFuZ2UgKHZhbHVlLCBtaW4sIG1heCkge1xyXG4gICAgcmV0dXJuIHZhbHVlID49IE1hdGgubWluKG1pbiwgbWF4KSAmJiB2YWx1ZSA8PSBNYXRoLm1heChtaW4sIG1heCk7XHJcbn1cclxuXHJcbmluaXQoKTsiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=